Mybatisäº‹åŠ¡ç®¡ç†
æˆ‘ä»¬å‰é¢å·²ç»è®²è§£äº†å¦‚ä½•è®©Mybatisä¸Springæ›´å¥½åœ°èåˆåœ¨ä¸€èµ· é€šè¿‡å°†å¯¹åº”çš„Beanç±»å‹æ³¨å†Œåˆ°å®¹å™¨ä¸­
å°±èƒ½æ›´åŠ æ–¹ä¾¿çš„å»ä½¿ç”¨Mapper é‚£ä¹ˆç°åœ¨ æˆ‘ä»¬æ¥ç€æ¥çœ‹Springçš„äº‹åŠ¡æ§åˆ¶

åœ¨å¼€å§‹ä¹‹å‰ æˆ‘ä»¬è¿˜æ˜¯å›é¡¾ä¸€ä¸‹äº‹åŠ¡æœºåˆ¶ é¦–å…ˆäº‹åŠ¡éµå¾ªä¸€ä¸ªACIDåŸåˆ™:

    > åŸå­æ€§(Atomicity): äº‹åŠ¡æ˜¯ä¸€ä¸ªåŸå­æ“ä½œ ç”±ä¸€ç³»åˆ—åŠ¨ä½œç»„æˆ äº‹åŠ¡çš„åŸå­æ€§ç¡®ä¿åŠ¨ä½œè¦ä¹ˆå…¨éƒ¨å®Œæˆ è¦ä¹ˆå®Œå…¨ä¸èµ·ä½œç”¨
    > ä¸€è‡´æ€§(Consistency): ä¸€æ—¦äº‹åŠ¡å®Œæˆ(ä¸ç®¡æˆåŠŸè¿˜æ˜¯å¤±è´¥) ç³»ç»Ÿå¿…é¡»ç¡®ä¿å®ƒæ‰€å»ºæ¨¡çš„ä¸šåŠ¡å¤„äºä¸€è‡´çš„çŠ¶æ€ è€Œä¸ä¼šæ˜¯éƒ¨åˆ†å®Œæˆéƒ¨åˆ†å¤±è´¥ åœ¨ç°å®ä¸­çš„æ•°æ®ä¸åº”è¯¥è¢«ç ´å
    > éš”ç¦»æ€§(Isolation): å¯èƒ½æœ‰è®¸å¤šäº‹åŠ¡åŒæ—¶å¤„ç†ç›¸åŒçš„æ•°æ® å› æ­¤æ¯ä¸ªäº‹åŠ¡éƒ½åº”è¯¥ä¸å…¶ä»–äº‹åŠ¡éš”ç¦»å¼€æ¥ é˜²æ­¢æ•°æ®æŸå
    > æŒä¹…æ€§(Durability): ä¸€æ—¦äº‹åŠ¡å®Œæˆ æ— è®ºå‘ç”Ÿä»€ä¹ˆç³»ç»Ÿé”™è¯¯ å®ƒçš„ç»“æœéƒ½ä¸åº”è¯¥å—åˆ°å½±å“ è¿™æ ·å°±èƒ½ä»ä»»ä½•ç³»ç»Ÿå´©æºƒä¸­æ¢å¤è¿‡æ¥ é€šå¸¸æƒ…å†µä¸‹ äº‹åŠ¡çš„ç»“æœè¢«å†™åˆ°æŒä¹…åŒ–å­˜å‚¨å™¨ä¸­

ç®€å•æ¥è¯´ äº‹åŠ¡å°±æ˜¯è¦ä¹ˆå®Œæˆ è¦ä¹ˆå°±å•¥éƒ½åˆ«åšğŸ™„ å¹¶ä¸”ä¸åŒçš„äº‹åŠ¡ç›´æ¥ç›¸äº’éš”ç¦» äº’ä¸å¹²æ‰°

é‚£ä¹ˆæˆ‘ä»¬æ¥ç€æ¥æ·±å…¥äº†è§£ä¸€ä¸‹äº‹åŠ¡çš„éš”ç¦»æœºåˆ¶(åœ¨ä¹‹å‰æ•°æ®åº“å…¥é—¨é˜¶æ®µå¹¶æ²¡æœ‰æåˆ°) æˆ‘ä»¬è¯´äº† äº‹åŠ¡ä¹‹é—´æ˜¯ç›¸äº’éš”ç¦»äº’ä¸å¹²æ‰°çš„ é‚£ä¹ˆå¦‚æœå‡ºç°äº†ä¸‹é¢çš„æƒ…å†µ ä¼šæ€ä¹ˆæ ·å‘¢:

    å½“ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶åœ¨æ‰§è¡Œ å¹¶ä¸”åŒæ—¶åœ¨æ“ä½œåŒä¸€ä¸ªæ•°æ® è¿™æ ·å¾ˆå®¹æ˜“å‡ºç°å¹¶å‘ç›¸å…³çš„é—®é¢˜ æ¯”å¦‚ä¸€ä¸ªäº‹åŠ¡å…ˆè¯»å–äº†æŸæ¡æ•°æ® è€Œå¦ä¸€ä¸ªäº‹åŠ¡æ­¤æ—¶ä¿®æ”¹äº†æ­¤æ•°æ®
    å½“å‰ä¸€ä¸ªäº‹åŠ¡ç´§æ¥ç€å†æ¬¡è¯»å–æ—¶ ä¼šå¯¼è‡´å’Œå‰ä¸€æ¬¡è¯»å–çš„æ•°æ®ä¸ä¸€è‡´ è¿™å°±æ˜¯ä¸€ç§å…¸å‹çš„æ•°æ®è™šåº¦ç°è±¡

å› æ­¤ ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ äº‹åŠ¡ä¹‹é—´å®é™…ä¸Šæ˜¯å­˜åœ¨ä¸€äº›éš”ç¦»çº§åˆ«çš„:

    > ISOLATION_READ_UNCOMMITTED(è¯»æœªæäº¤): å…¶ä»–äº‹åŠ¡ä¼šè¯»å–å½“å‰äº‹åŠ¡å°šä¸ºæœªæ›´æ–°çš„æäº¤(ç›¸å½“äºè¯»å–çš„æ˜¯è¿™ä¸ªäº‹åŠ¡æš‚æ—¶ç¼“å­˜çš„å†…å®¹ å¹¶ä¸æ˜¯æ•°æ®åº“ä¸­çš„å†…å®¹)
    > ISOLATION_READ_COMMITTED(è¯»å·²æäº¤): å…¶ä»–äº‹åŠ¡ä¼šè¯»å–å½“å‰äº‹åŠ¡å·²ç»æäº¤çš„æ•°æ®(ä¹Ÿå°±æ˜¯ç›´æ¥è¯»å–æ•°æ®åº“ä¸­å·²ç»å‘ç”Ÿæ›´æ”¹çš„å†…å®¹)
    > ISOLATION_REPEATABLE_READ(å¯é‡å¤è¯»): å…¶ä»–äº‹åŠ¡ä¼šè¯»å–å½“å‰äº‹åŠ¡å·²å°†æäº¤çš„æ•°æ®å¹¶ä¸”å…¶ä»–äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å…è®¸å†è¿›è¡Œæ•°æ®ä¿®æ”¹(æ³¨æ„: è¿™é‡Œä»…ä»…æ˜¯ä¸å…è®¸ä¿®æ”¹æ•°æ®)
    > ISOLATION_SERIALIZABLE(ä¸²è¡ŒåŒ–): å®ƒå®Œå…¨æœä»ACIDåŸåˆ™ ä¸€ä¸ªäº‹åŠ¡å¿…é¡»ç­‰å¾…å…¶ä»–äº‹åŠ¡ç»“æŸä¹‹åæ‰èƒ½å¼€å§‹æ‰§è¡Œ ç›¸å¯¹äºæŒ¨ä¸ªæ‰§è¡Œ æ•ˆç‡å¾ˆä½

æˆ‘ä»¬ä¾æ¬¡æ¥æ¥çœ‹çœ‹ ä¸åŒçš„éš”ç¦»çº§åˆ«ä¼šå¯¼è‡´ä»€ä¹ˆé—®é¢˜ é¦–å…ˆæ˜¯è¯»æœªæäº¤çº§åˆ« æ­¤çº§åˆ«å±äºæœ€ä½çº§åˆ« ç›¸å½“äºå„ä¸ªäº‹åŠ¡å…±äº«ä¸€ä¸ªç¼“å­˜åŒºåŸŸğŸ”‚ ä»»ä½•äº‹åŠ¡çš„æ“ä½œéƒ½åœ¨è¿™é‡Œè¿›è¡Œ é‚£ä¹ˆå®ƒä¼šå¯¼è‡´ä»¥ä¸‹é—®é¢˜:

    https://smms.app/image/hQpluLA2bFKo1O8

ä¹Ÿå°±æ˜¯è¯´ äº‹åŠ¡Aæœ€åå¾—åˆ°çš„å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ¯«æ— æ„ä¹‰çš„æ•°æ®(äº‹åŠ¡Bå·²ç»å›æ»šäº†) æˆ‘ä»¬ç§°æ­¤æ•°æ®ä¸º"è„æ•°æ®" è¿™ç§ç°è±¡ç§°ä¸ºè„è¯»

æˆ‘ä»¬æ¥ç€æ¥çœ‹è¯»å·²æäº¤çº§åˆ« äº‹åŠ¡åªèƒ½è¯»å–å…¶ä»–äº‹åŠ¡å·²ç»æäº¤çš„å†…å®¹ ç›¸å½“äºç›´æ¥ä»æ•°æ®ä¸­è¯»å–æ•°æ® è¿™æ ·å°±å¯ä»¥é¿å…è„è¯»é—®é¢˜äº† ä½†æ˜¯å®ƒè¿˜æ˜¯å­˜åœ¨ä»¥ä¸‹é—®é¢˜:

    https://smms.app/image/K1sJbDNyudOgAcV

è¿™æ­£æ˜¯æˆ‘ä»¬å‰é¢ä¾‹å­ä¸­æåˆ°çš„é—®é¢˜ è™½ç„¶å®ƒé¿å…äº†è„è¯»é—®é¢˜ ä½†æ˜¯å¦‚æœäº‹ä»¶Bä¿®æ”¹å¹¶æäº¤äº†æ•°æ®
é‚£ä¹ˆå®é™…ä¸Šäº‹åŠ¡Aä¹‹å‰è¯»å–åˆ°çš„æ•°æ®ä¾ç„¶ä¸æ˜¯æœ€æ–°çš„æ•°æ® ç›´æ¥å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ è¿™ç§ç°è±¡ç§°ä¸ºè™šè¯»ä¹Ÿå¯ä»¥ç§°ä¸ºä¸å¯é‡å¤è¯»

å› æ­¤ ä¸‹ä¸€ä¸ªéš”ç¦»çº§åˆ«å¯é‡å¤è¯»å°±èƒ½å¤Ÿè§£å†³è¿™æ ·çš„é—®é¢˜(MySQLçš„é»˜è®¤éš”ç¦»çº§åˆ«) å®ƒè§„å®šåœ¨å…¶ä»–äº‹åŠ¡æ‰§è¡Œæ—¶ ä¸å…è®¸ä¿®æ”¹æ•°æ®
è¿™æ · å°±å¯ä»¥æœ‰æ•ˆåœ°é¿å…ä¸å¯é‡å¤è¯»çš„é—®é¢˜ ä½†æ˜¯è¿™æ ·å°±ä¸€å®šå®‰å…¨äº†å—?â˜ è¿™é‡Œä»…ä»…æ˜¯ç¦æ­¢äº†äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çš„UPDATEæ“ä½œ
ä½†æ˜¯å®ƒå¹¶æ²¡æœ‰ç¦æ­¢INSERTè¿™ç±»æ“ä½œ å› æ­¤ å¦‚æœäº‹åŠ¡Aæ‰§è¡Œè¿‡ç¨‹ä¸­äº‹åŠ¡Bæ’å…¥äº†æ–°çš„æ•°æ® é‚£ä¹ˆAè¿™æ—¶æ˜¯æ¯«ä¸çŸ¥æƒ…çš„ æ¯”å¦‚:

    https://smms.app/image/uwiHT8AcobeBjL3

ä¸¤ä¸ªäººåŒæ—¶æŠ¥åä¸€ä¸ªæ´»åŠ¨ ä¸¤ä¸ªæŠ¥åçš„äº‹åŠ¡åŒæ—¶åœ¨è¿›è¡Œ ä½†æ˜¯ä»–ä»¬ä¸€å¼€å§‹è¯»å–åˆ°çš„äººæ•°éƒ½æ˜¯5 è€Œè¿™æ—¶ å®ƒä»¬éƒ½ä¼šè®¤ä¸ºæŠ¥åæˆåŠŸåäººæ•°åº”è¯¥å˜æˆ6 è€Œæ­£å¸¸æƒ…å†µä¸‹åº”è¯¥æ˜¯7 å› æ­¤ è¿™ä¸ªæ—¶å€™å°±å‘ç”Ÿäº†æ•°æ®çš„å¹»è¯»ç°è±¡

å› æ­¤ è¦è§£å†³è¿™ç§é—®é¢˜ åªèƒ½ä½¿ç”¨æœ€åä¸€ç§éš”ç¦»çº§åˆ«ä¸²è¡ŒåŒ–æ¥å®ç°äº† æ¯ä¸ªäº‹åŠ¡ä¸èƒ½åŒæ—¶è¿›è¡Œ ç›´æ¥é¿å…æ‰€æœ‰å¹¶å‘é—®é¢˜ ç®€å•ç²—æš´ ä½†æ˜¯æ•ˆç‡çˆ†å‡ å¹¶ä¸æ¨è

æœ€åæ€»ç»“ä¸‰ç§æƒ…å†µ:

    > è„è¯»: è¯»å–åˆ°äº†è¢«å›æ»šçš„æ•°æ® å®ƒæ¯«æ— æ„ä¹‰
    > è™šè¯»(ä¸å¯é‡å¤è¯»): ç”±äºå…¶ä»–äº‹åŠ¡æ›´æ–°æ•°æ® ä¸¤æ¬¡è¯»å–çš„æ•°æ®ä¸ä¸€è‡´
    > å¹»è¯»: ç”±äºå…¶ä»–äº‹åŠ¡æ‰§è¡Œæ’å…¥åˆ é™¤æ“ä½œ è€Œåˆæ— æ³•æ„ŸçŸ¥åˆ°è¡¨ä¸­è®°å½•æ¡æ•°å‘ç”Ÿæ”¹å˜ å½“ä¸‹æ¬¡å†è¯»å–æ—¶ä¼šè«åå…¶å¦™å¤šå‡ºæˆ–ç¼ºå¤±æ•°æ® å°±åƒäº§ç”Ÿå¹»è§‰ä¸€æ ·

(å¯¹äºè™šè¯»å’Œå¹»è¯»çš„åŒºåˆ†: è™šè¯»æ˜¯æŸæ•°æ®å‰åè¯»å–ä¸ä¸€è‡´ å¹»è¯»æ˜¯æ•´ä¸ªè¡¨çš„è®°å½•æ•°é‡å‰åè¯»å–ä¸ä¸€è‡´)

æœ€åè¿™å¼ å›¾ è¯·åŠ¡å¿…è®°åœ¨ä½ çš„è„‘æµ· è®°åœ¨ä½ çš„å¿ƒä¸­ğŸŒ›:

    https://smms.app/image/nHfV8R1ZUybTSd2

--------------------------------------------------------------------------------------------------------------------------------------------------------------

Mybatiså¯¹äºæ•°æ®åº“çš„äº‹åŠ¡ç®¡ç† ä¹Ÿæœ‰ç€ç›¸åº”çš„å°è£… ä¸€ä¸ªäº‹åŠ¡æ— éå°±æ˜¯åˆ›å»º æäº¤ å›æ»š å…³é—­ å› æ­¤è¿™äº›æ“ä½œè¢«MybatisæŠ½è±¡ä¸ºä¸€ä¸ªæ¥å£:

                    public interface Transaction {
                        Connection getConnection() throws SQLException;

                        void commit() throws SQLException;

                        void rollback() throws SQLException;

                        void close() throws SQLException;

                        Integer getTimeout() throws SQLException;
                    }

å¯¹äºæ­¤æ¥å£çš„å®ç° Mybatisçš„äº‹åŠ¡ç®¡ç†åˆ†ä¸ºä¸¤ç§å½¢å¼:

    1. ä½¿ç”¨JDBCçš„äº‹åŠ¡ç®¡ç†æœºåˆ¶: å³åˆ©ç”¨å¯¹åº”æ•°æ®åº“çš„é©±åŠ¨ç”Ÿæˆçš„Connectionå¯¹è±¡å®Œæˆå¯¹äº‹åŠ¡çš„æäº¤Commit() å›æ»šrollback() å…³é—­close()ç­‰ å¯¹åº”çš„å®ç°ç±»ä¸ºJdbcTransaction

    2. ä½¿ç”¨MANAGEDçš„äº‹åŠ¡ç®¡ç†æœºåˆ¶: è¿™ç§æœºåˆ¶Mybatisè‡ªèº«ä¸ä¼šå»å®ç°äº‹åŠ¡ç®¡ç† è€Œæ˜¯è®©ç¨‹åºçš„å®¹å™¨(æ¯”å¦‚Spring)æ¥å®ç°å¯¹äº‹åŠ¡çš„ç®¡ç† å¯¹åº”çš„å®ç°ç±»ä¸ºManagedTransaction

è€Œæˆ‘ä¹‹å‰ä¸€ç›´ä½¿ç”¨çš„å…¶å®å°±æ˜¯JDBCçš„äº‹åŠ¡ ç›¸å½“äºç›´æ¥ä½¿ç”¨Connectionå¯¹è±¡(ä¹‹å‰JavaWebé˜¶æ®µå·²ç»è®²è§£è¿‡äº†)åœ¨è¿›è¡Œäº‹åŠ¡æ“ä½œ å¹¶æ²¡æœ‰é¢å¤–çš„ç®¡ç†æœºåˆ¶ å¯¹åº”çš„é…ç½®ä¸º:

                    <transactionManager type="JDBC"/>

é‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹çœ‹JdbcTransactionæ˜¯ä¸æ˜¯åƒæˆ‘ä»¬ä¸Šé¢æ‰€è¯´çš„é‚£æ ·ç®¡ç†äº‹åŠ¡çš„ ç›´æ¥ä¸Šæºç âš¡:

                    public class JdbcTransaction implements Transaction {
                        private static final Log log = LogFactory.getLog(JdbcTransaction.class);
                        protected Connection connection;
                        protected DataSource dataSource;
                        protected TransactionIsolationLevel level;
                        protected boolean autoCommit;

                        public JdbcTransaction(DataSource ds, TransactionIsolationLevel desiredLevel, boolean desiredAutoCommit) {
                              // æ•°æ®æº
                            this.dataSource = ds;
                              // äº‹åŠ¡éš”ç¦»çº§åˆ« ä¸Šé¢å·²ç»æåˆ°è¿‡äº†
                            this.level = desiredLevel;
                              // æ˜¯å¦è‡ªåŠ¨æäº¤
                            this.autoCommit = desiredAutoCommit;
                        }

                      // ä¹Ÿå¯ä»¥ç›´æ¥ç»™ä¸ªConnectionå¯¹è±¡
                       public JdbcTransaction(Connection connection) {
                            this.connection = connection;
                        }

                        public Connection getConnection() throws SQLException {
                              // æ²¡æœ‰å°±é€šè¿‡æ•°æ®æºæ–°å¼€ä¸€ä¸ªConnection
                            if (this.connection == null) {
                                this.openConnection();
                            }

                            return this.connection;
                        }

                        public void commit() throws SQLException {
                              // è¿æ¥å·²ç»åˆ›å»ºå¹¶ä¸”æ²¡å¼€å¯è‡ªåŠ¨æäº¤æ‰å¯ä»¥ä½¿ç”¨
                            if (this.connection != null && !this.connection.getAutoCommit()) {
                                if (log.isDebugEnabled()) {
                                    log.debug("Committing JDBC Connection [" + this.connection + "]");
                                }
                                // å®é™…ä¸Šä½¿ç”¨çš„æ˜¯æ•°æ®åº“é©±åŠ¨æä¾›çš„Connectionå¯¹è±¡è¿›è¡Œäº‹åŠ¡æ“ä½œ
                                this.connection.commit();
                            }
                        }
                          ...

ç›¸å½“äºJdbcTransactionåªæ˜¯ä¸ºæ•°æ®åº“é©±åŠ¨æä¾›çš„Connectionå¯¹è±¡å¥—äº†å±‚å£³ æ‰€æœ‰çš„äº‹åŠ¡æ“ä½œå®é™…ä¸Šæ˜¯ç›´æ¥è°ƒç”¨Connectionå¯¹è±¡ é‚£ä¹ˆæˆ‘ä»¬æ¥ç€æ¥çœ‹ManagedTransactionçš„æºç :

                    public class ManagedTransaction implements Transaction {
                        ...

                        public void commit() throws SQLException {
                        }

                        public void rollback() throws SQLException {
                        }

                        ...
                    }

æˆ‘ä»¬å‘ç° å¤§ä½“å†…å®¹å’ŒJdbcTransactionå·®ä¸å¤š ä½†æ˜¯å®ƒå¹¶æ²¡æœ‰å®ç°ä»»ä½•çš„äº‹åŠ¡æ“ä½œ ä¹Ÿå°±æ˜¯è¯´ å®ƒå¸Œæœ›å°†å®ç°äº¤ç»™å…¶ä»–çš„ç®¡ç†æ¡†æ¶æ¥å®Œæˆ è€ŒSpringå°±ä¸ºMybatisæä¾›äº†ä¸€ä¸ªéå¸¸å¥½çš„äº‹åŠ¡ç®¡ç†å®ç°ğŸ•¹