Mybatisæ•´åˆåŸç†
é€šè¿‡ä¹‹å‰çš„äº†è§£ æˆ‘ä»¬å†æ¥çœ‹Mybatisçš„@MapperScanæ˜¯å¦‚ä½•å®ç°çš„ ç°åœ¨ç†è§£èµ·æ¥å°±éå¸¸ç®€å•äº†ğŸ¤

æˆ‘ä»¬å¯ä»¥ç›´æ¥æ‰“å¼€æŸ¥çœ‹:

                    @Retention(RetentionPolicy.RUNTIME)
                    @Target({ElementType.TYPE})
                    @Documented
                    @Import({MapperScannerRegistrar.class})
                    @Repeatable(MapperScans.class)
                    public @interface MapperScan {
                        String[] value() default {};

                        String[] basePackages() default {};
                          ...

æˆ‘ä»¬å‘ç° å’ŒAOPä¸€æ · å®ƒä¹Ÿæ˜¯é€šè¿‡Registraræœºåˆ¶ é€šè¿‡@Importæ¥è¿›è¡ŒBeançš„æ³¨å†Œ æˆ‘ä»¬æ¥çœ‹çœ‹MapperScannerRegistraræ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ å…³é”®ä»£ç å¦‚ä¸‹:

                    void registerBeanDefinitions(AnnotationMetadata annoMeta, AnnotationAttributes annoAttrs, BeanDefinitionRegistry registry, String beanName) {
                        BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition(MapperScannerConfigurer.class);
                        builder.addPropertyValue("processPropertyPlaceHolders", true);
                        Class<? extends Annotation> annotationClass = annoAttrs.getClass("annotationClass");
                        if (!Annotation.class.equals(annotationClass)) {
                            builder.addPropertyValue("annotationClass", annotationClass);
                        }

                        Class<?> markerInterface = annoAttrs.getClass("markerInterface");
                        if (!Class.class.equals(markerInterface)) {
                            builder.addPropertyValue("markerInterface", markerInterface);
                        }

                        Class<? extends BeanNameGenerator> generatorClass = annoAttrs.getClass("nameGenerator");
                        if (!BeanNameGenerator.class.equals(generatorClass)) {
                            builder.addPropertyValue("nameGenerator", BeanUtils.instantiateClass(generatorClass));
                        }

                        Class<? extends MapperFactoryBean> mapperFactoryBeanClass = annoAttrs.getClass("factoryBean");
                        if (!MapperFactoryBean.class.equals(mapperFactoryBeanClass)) {
                            builder.addPropertyValue("mapperFactoryBeanClass", mapperFactoryBeanClass);
                        }

                        String sqlSessionTemplateRef = annoAttrs.getString("sqlSessionTemplateRef");
                        if (StringUtils.hasText(sqlSessionTemplateRef)) {
                            builder.addPropertyValue("sqlSessionTemplateBeanName", annoAttrs.getString("sqlSessionTemplateRef"));
                        }

                        String sqlSessionFactoryRef = annoAttrs.getString("sqlSessionFactoryRef");
                        if (StringUtils.hasText(sqlSessionFactoryRef)) {
                            builder.addPropertyValue("sqlSessionFactoryBeanName", annoAttrs.getString("sqlSessionFactoryRef"));
                        }

                        List<String> basePackages = new ArrayList();
                        basePackages.addAll((Collection)Arrays.stream(annoAttrs.getStringArray("value")).filter(StringUtils::hasText).collect(Collectors.toList()));
                        basePackages.addAll((Collection)Arrays.stream(annoAttrs.getStringArray("basePackages")).filter(StringUtils::hasText).collect(Collectors.toList()));
                        basePackages.addAll((Collection)Arrays.stream(annoAttrs.getClassArray("basePackageClasses")).map(ClassUtils::getPackageName).collect(Collectors.toList()));
                        if (basePackages.isEmpty()) {
                            basePackages.add(getDefaultBasePackage(annoMeta));
                        }

                        String lazyInitialization = annoAttrs.getString("lazyInitialization");
                        if (StringUtils.hasText(lazyInitialization)) {
                            builder.addPropertyValue("lazyInitialization", lazyInitialization);
                        }

                        String defaultScope = annoAttrs.getString("defaultScope");
                        if (!"".equals(defaultScope)) {
                            builder.addPropertyValue("defaultScope", defaultScope);
                        }

                        builder.addPropertyValue("basePackage", StringUtils.collectionToCommaDelimitedString(basePackages));
                        registry.registerBeanDefinition(beanName, builder.getBeanDefinition());
                    }

è™½ç„¶å¾ˆé•¿å¾ˆå¤šğŸ’« ä½†æ˜¯è¿™äº›ä»£ç éƒ½æ˜¯åœ¨æ·»åŠ ä¸€äº›Beanå®šä¹‰çš„å±æ€§ è€Œæœ€å…³é”®çš„åˆ™æ˜¯æœ€ä¸Šæ–¹çš„MapperScannerConfigurer Mybatiså°†å…¶Beanä¿¡æ¯æ³¨å†Œåˆ°äº†å®¹å™¨ä¸­ é‚£ä¹ˆè¿™ä¸ªç±»åˆæ˜¯å¹²å˜›çš„å‘¢?

                    public class MapperScannerConfigurer implements BeanDefinitionRegistryPostProcessor, InitializingBean, ApplicationContextAware, BeanNameAware {
                        private String basePackage;

å®ƒå®ç°äº†BeanDefinitionRegistryPostProcessor ä¹Ÿå°±æ˜¯è¯´å®ƒä¸ºBeanä¿¡æ¯åŠ è½½æä¾›äº†åç½®å¤„ç† æˆ‘ä»¬æ¥ç€æ¥çœ‹çœ‹å®ƒåœ¨Beanä¿¡æ¯åå¤„ç†ä¸­åšäº†ä»€ä¹ˆ:

                    public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) {
                        if (this.processPropertyPlaceHolders) {
                            this.processPropertyPlaceHolders();
                        }

                        // åˆå§‹åŒ–ç±»è·¯å¾„Mapperæ‰«æå™¨ å®ƒç›¸å½“äºæ˜¯ä¸€ä¸ªå·¥å…·ç±» å¯ä»¥å¿«é€Ÿæ‰«æå‡ºæ•´ä¸ªåŒ…ä¸‹çš„ç±»å®šä¹‰ä¿¡æ¯
                        // ClassPathMapperScanneræ˜¯Mybatisè‡ªå·±å®ç°çš„ä¸€ä¸ªæ‰«æå™¨ ä¿®æ”¹äº†ä¸€äº›æ‰«æè§„åˆ™
                        ClassPathMapperScanner scanner = new ClassPathMapperScanner(registry);
                        scanner.setAddToConfig(this.addToConfig);
                        scanner.setAnnotationClass(this.annotationClass);
                        scanner.setMarkerInterface(this.markerInterface);
                        scanner.setSqlSessionFactory(this.sqlSessionFactory);
                        scanner.setSqlSessionTemplate(this.sqlSessionTemplate);
                        scanner.setSqlSessionFactoryBeanName(this.sqlSessionFactoryBeanName);
                        scanner.setSqlSessionTemplateBeanName(this.sqlSessionTemplateBeanName);
                        scanner.setResourceLoader(this.applicationContext);
                        scanner.setBeanNameGenerator(this.nameGenerator);
                        scanner.setMapperFactoryBeanClass(this.mapperFactoryBeanClass);
                        if (StringUtils.hasText(this.lazyInitialization)) {
                            scanner.setLazyInitialization(Boolean.valueOf(this.lazyInitialization));
                        }

                        if (StringUtils.hasText(this.defaultScope)) {
                            scanner.setDefaultScope(this.defaultScope);
                        }

                        // æ·»åŠ è¿‡æ»¤å™¨ è¿™é‡Œä¼šé…ç½®ä¸ºæ‰€æœ‰çš„æ¥å£éƒ½èƒ½è¢«æ‰«æ(å› æ­¤å³ä½¿ä½ ä¸æ·»åŠ @Mapperæ³¨è§£éƒ½èƒ½å¤Ÿè¢«æ‰«æå¹¶åŠ è½½)
                        scanner.registerFilters();
                        // å¼€å§‹æ‰«æ
                        scanner.scan(StringUtils.tokenizeToStringArray(this.basePackage, ",; \t\n"));
                    }

å¼€å§‹æ‰«æå ä¼šè°ƒç”¨doScan()æ–¹æ³• æˆ‘ä»¬æ¥ç€æ¥çœ‹(è¿™æ˜¯ClassPathMapperScannerä¸­çš„æ‰«ææ–¹æ³•):

                    public Set<BeanDefinitionHolder> doScan(String... basePackages) {
                        Set<BeanDefinitionHolder> beanDefinitions = super.doScan(basePackages);
                        // é¦–å…ˆä»åŒ…ä¸­æ‰«ææ‰€æœ‰çš„Beanå®šä¹‰
                        if (beanDefinitions.isEmpty()) {
                            LOGGER.warn(() -> {
                                return "No MyBatis mapper was found in '" + Arrays.toString(basePackages) + "' package. Please check your configuration.";
                            });
                        } else {
                            // å¤„ç†æ‰€æœ‰çš„Beanå®šä¹‰ å®é™…ä¸Šå°±æ˜¯ç”Ÿæˆå¯¹åº”Mapperçš„ä»£ç†å¯¹è±¡ å¹¶æ³¨å†Œåˆ°å®¹å™¨ä¸­
                            this.processBeanDefinitions(beanDefinitions);
                        }

                        // æœ€åè¿”å›æ‰€æœ‰çš„Beanå®šä¹‰é›†åˆ
                        return beanDefinitions;
                    }

é€šè¿‡æ–­ç‚¹æˆ‘ä»¬å‘ç° æœ€åå¤„ç†å¾—åˆ°çš„Beanå®šä¹‰å‘ç°æ­¤Beanæ˜¯ä¸€ä¸ªMapperFactoryBean å®ƒä¸åŒäºæ™®é€šçš„Bean FactoryBeanç›¸å½“äºä¸ºæ™®é€šçš„Beanæ·»åŠ äº†ä¸€å±‚å¤–å£³
å®ƒå¹¶ä¸æ˜¯ä¾é Springç›´æ¥é€šè¿‡åå°„åˆ›å»º è€Œæ˜¯ä½¿ç”¨æ¥å£ä¸­çš„æ–¹æ³•:

                    public interface FactoryBean<T> {
                        String OBJECT_TYPE_ATTRIBUTE = "factoryBeanObjectType";

                        @Nullable
                        T getObject() throws Exception;

                        @Nullable
                        Class<?> getObjectType();

                        default boolean isSingleton() {
                            return true;
                        }
                    }

é€šè¿‡getObject()æ–¹æ³• å°±å¯ä»¥è·å–åˆ°Beançš„å®ä¾‹äº†

æ³¨æ„è¿™é‡Œä¸€å®šè¦åŒºåˆ†FactoryBeanå’ŒBeanFactoryçš„æ¦‚å¿µâ¬:

    > BeanFactoryæ˜¯ä¸ªFactory ä¹Ÿå°±æ˜¯IoCå®¹å™¨æˆ–å¯¹è±¡å·¥å‚ æ‰€æœ‰çš„Beanéƒ½æ˜¯ç”±BeanFactory(ä¹Ÿå°±æ˜¯IoCå®¹å™¨)æ¥è¿›è¡Œç®¡ç†

    > FactoryBeanæ˜¯ä¸€ä¸ªèƒ½ç”Ÿäº§æˆ–è€…ä¿®é¥°ç”Ÿäº§å¯¹è±¡çš„å·¥å‚Bean(æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªBean) å¯ä»¥åœ¨BeanFactory(IoCå®¹å™¨)ä¸­è¢«ç®¡ç† æ‰€ä»¥å®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªç®€å•çš„Bean
      å½“ä½¿ç”¨å®¹å™¨ä¸­factory beançš„æ—¶å€™ è¯¥å®¹å™¨ä¸ä¼šè¿”å›factory beanæœ¬èº« è€Œæ˜¯è¿”å›å…¶ç”Ÿäº§çš„å¯¹è±¡ è¦æƒ³è·å–FactoryBeanå®ç°ç±»æœ¬èº«
      å¾—åœ¨getBean(String BeanName)ä¸­çš„BeanNameä¹‹å‰åŠ ä¸Š& å†™æˆgetBean(String &BeanName)

æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±ç¼–å†™ä¸€ä¸ªå®ç°:

                    @Component("test")
                    public class TestFb implements FactoryBean<Student> {

                        @Override
                        public Student getObject() throws Exception {

                            System.out.println("è·å–äº†å­¦ç”Ÿ");
                            return new Student();

                        }

                        @Override
                        public Class<?> getObjectType() {
                            return Student.class;
                        }

                    }

                    public static void main(String[] args) {

                        log.info("é¡¹ç›®æ­£åœ¨å¯åŠ¨...")
                        ApplicationContext context = new AnnotationConfigApplicationContext(TestConfiguration.class);
                        System.out.println(context.getBean("&test")); // å¾—åˆ°FactoryBeanæœ¬èº«(å¾—åŠ ä¸ª&æå¾—åƒCè¯­è¨€æŒ‡é’ˆä¸€æ ·ğŸ˜†)
                        System.out.println(context.getBean("test")); // å¾—åˆ°FactoryBeanè°ƒç”¨getObject()ä¹‹åçš„ç»“æœ

                    }

å› æ­¤ å®é™…ä¸Šæˆ‘ä»¬çš„Mapperæœ€ç»ˆå°±ä»¥FactoryBeançš„å½¢å¼ è¢«æ³¨å†Œåˆ°å®¹å™¨ä¸­è¿›è¡ŒåŠ è½½äº†:

                    public T getObject() throws Exception {
                        return this.getSqlSession().getMapper(this.mapperInterface);
                    }

è¿™æ · æ•´ä¸ªMybatis@MapperScançš„åŸç†å°±å…¨éƒ¨è§£é‡Šå®Œæ¯•äº†

åœ¨äº†è§£å®Œäº†Springçš„åº•å±‚åŸç†ä¹‹å æˆ‘ä»¬å…¶å®å·²ç»å®Œå…¨å¯ä»¥æ ¹æ®è¿™äº›å®ç°åŸç†æ¥æ‰‹å†™ä¸€ä¸ªSpringæ¡†æ¶äº†