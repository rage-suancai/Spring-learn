Springå®ç°åŸç†æ¢ç©¶(é€‰å­¦)
æ³¨æ„: æœ¬ç‰ˆå—éš¾åº¦å¾ˆå¤§ æ‰€æœ‰å†…å®¹éƒ½ä½œä¸ºé€‰å­¦å†…å®¹

å¦‚æœå­¦ä¹ SpringåŸºæœ¬å†…å®¹å¯¹ä½ æ¥è¯´å·²ç»éå¸¸å›°éš¾äº† å»ºè®®è·³è¿‡æ­¤æœ¬ç« âœ‹ ç›´æ¥è¿›å…¥MVCé˜¶æ®µçš„å­¦ä¹  æ­¤å°èŠ‚ä¼šä»æºç è§’åº¦è§£é‡ŠSpringçš„æ•´ä¸ªè¿è¡ŒåŸç†
å¯¹åˆå­¦è€…æ¥è¯´ç­‰åŒäºå°å­¦è·¨è¶Šåˆ°é«˜ä¸­ å®ƒå¹¶ä¸æ˜¯å¿…å­¦å†…å®¹ ä½†æ˜¯å¯¹äºä¸ªäººé˜…å†æç¤ºæä¸ºé‡è¦(æ¨èå®Œæˆæ•´ä¸ªSSMé˜¶æ®µçš„å­¦ä¹ å¹¶ä¸”åŠ ä»¥å®æˆ˜ä¹‹åå†æ¥çœ‹æ­¤éƒ¨åˆ†)
å¦‚æœä½ è¿˜æ˜¯è§‰å¾—è‡ªå·±èƒ½å¤Ÿè·Ÿä¸ŠèŠ‚å¥ç»§ç»­æ·±å…¥é’»ç ”åº•å±‚åŸç† é‚£ä¹ˆç°åœ¨å°±å¼€å§‹å§ğŸ‘Š

Beanå·¥å‚ä¸Beanå®šä¹‰
å®é™…ä¸Šæˆ‘ä»¬ä¹‹å‰çš„æ‰€æœ‰æ“ä½œéƒ½ç¦»ä¸å¼€ä¸€ä¸ªä¸œè¥¿ é‚£å°±æ˜¯IoCå®¹å™¨ é‚£ä¹ˆå®ƒåˆ°åº•æ˜¯å¦‚ä½•å®ç°å‘¢? è¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬å°†è¯¦ç»†ä»‹ç» é¦–å…ˆæˆ‘ä»¬å¤§è‡´äº†è§£ä¸€ä¸‹ApplicationContextçš„åŠ è½½æµç¨‹:

        https://smms.app/image/Un6qjPci2uvkL5X

æˆ‘ä»¬å¯ä»¥çœ‹åˆ° æ•´ä¸ªè¿‡ç¨‹æä¸ºå¤æ‚ ä¸€å¥è¯è‚¯å®šæ˜¯æ— æ³•è§£é‡Šçš„ ç”±äºSpringçš„æºç éå¸¸åºå¤§ å› æ­¤æˆ‘ä»¬ä¸å¯èƒ½å†åƒäº†è§£å…¶ä»–æ¡†æ¶é‚£æ ·ç›´æ¥è‡ªä½å‘ä¸Šé€è¡Œå¹²æºç äº†
(å„ä½å¯ä»¥è‡ªå·±ç‚¹å¼€çœ‹çœ‹ ä»£ç é‡éå¸¸å¤š)ğŸ¤’

        https://smms.app/image/QXqvO1sGh6d4ZSz

æˆ‘ä»¬éœ€è¦å…ˆä»éå¸¸å°çš„ç‚¹å¼€å§‹è¿›è¡Œä»‹ç» æœ€åå°†æ‰€æœ‰ç‚¹æ±‡æ€»æ‰èƒ½ç“¦è§£æ•´å¿«æ‹¼å›¾

é¦–å…ˆ å®¹å™¨æ—¢ç„¶è¦ç®¡ç†Bean é‚£ä¹ˆè‚¯å®šéœ€è¦ä¸€ä¸ªå®Œå–„çš„ç®¡ç†æœºåˆ¶ å®é™…ä¸Š å¯¹Beançš„ç®¡ç†éƒ½æ˜¯ä¾é BeanFactoryåœ¨è¿›è¡Œ
é¡¾åæ€ä¹‰BeanFactoryå°±æ˜¯å¯¹Beanè¿›è¡Œç”Ÿäº§å’Œç®¡ç†çš„å·¥å‚ æˆ‘ä»¬å¯ä»¥è‡ªå·±å°è¯•è‡ªå·±åˆ›å»ºå’Œä½¿ç”¨BeanFactoryå¯¹è±¡:

                    public static void main(String[] args) {

                        DefaultListableBeanFactory factory = new DefaultListableBeanFactory(); // è¿™æ˜¯BeanFactoryçš„ä¸€ä¸ªé»˜è®¤å®ç°ç±»
                        System.out.println("è·å–Beanå¯¹è±¡: " + factory.getBean("lbwnb")); // æˆ‘ä»¬å¯ä»¥ç›´æ¥æ‰¾å·¥å‚è·å–Beanå¯¹è±¡

                    }

æˆ‘ä»¬å¯ä»¥ç›´æ¥æ‰¾Beanå·¥å‚ç´¢è¦å¯¹è±¡ åªä¸è¿‡åœ¨ä¸€å¼€å§‹ å·¥å‚å¹¶ä¸çŸ¥é“è‡ªå·±éœ€è¦ç”Ÿäº§ä»€ä¹ˆ å¯ä»¥ç”Ÿäº§ä»€ä¹ˆ å› æ­¤æˆ‘ä»¬ç›´æ¥ç´¢è¦ä¸€ä¸ªå·¥å‚ä¸çŸ¥é“çš„Beanå¯¹è±¡ ä¼šç›´æ¥å¾—åˆ°:

        https://smms.app/image/n54N3iFQX7awHAl

æˆ‘ä»¬åªæœ‰å‘Šè¯‰å·¥å‚æˆ‘ä»¬è¦ç”Ÿäº§ä»€ä¹ˆ æ€ä¹ˆç”Ÿäº§ å·¥å‚æ‰èƒ½å¼€å·¥:

                    public static void main(String[] args) {

                        DefaultListableBeanFactory factory = new DefaultListableBeanFactory(); // è¿™æ˜¯BeanFactoryçš„ä¸€ä¸ªé»˜è®¤å®ç°ç±»

                        BeanDefinition definition = BeanDefinitionBuilder // ä½¿ç”¨BeanDefinitionBuilderå¿«é€Ÿåˆ›å»ºBeanå®šä¹‰
                                .rootBeanDefinition(Student.class); // Beançš„ç±»å‹
                                .setScope("prototype") // è®¾ç½®ä½œç”¨åŸŸä¸ºåŸå‹æ¨¡å¼
                                .getBeanDefinition(); // ç”Ÿæˆæ­¤Beanå®šä¹‰
                        factory.registerBeanDefinition("lbwnb", definition); // å‘å·¥å‚æ³¨å†ŒBeanæ­¤å®šä¹‰ å¹¶è®¾å®šBeançš„åç§°

                        System.out.println(factory.getBean("lbwnb")); // ç°åœ¨å°±å¯ä»¥æ‹¿åˆ°äº†

                    }

å®é™…ä¸Š æˆ‘ä»¬çš„ApplicationContextä¸­å°±ç»´æŠ¤äº†ä¸€ä¸ªAutowireCapableBeanFactoryå¯¹è±¡:

                    public abstract class AbstractRefreshableApplicationContext extends AbstractApplicationContext {
                         @Nullable
                         private volatile DefaultListableBeanFactory beanFactory;   // é»˜è®¤æ„é€ åå­˜æ”¾åœ¨è¿™é‡Œçš„æ˜¯ä¸€ä¸ªDefaultListableBeanFactoryå¯¹è±¡

                        ...

                        @Override
                        public final ConfigurableListableBeanFactory getBeanFactory() {   // getBeanFactoryå°±å¯ä»¥ç›´æ¥å¾—åˆ°ä¸Šé¢çš„å¯¹è±¡äº†
                           DefaultListableBeanFactory beanFactory = this.beanFactory;
                           if (beanFactory == null) {
                              throw new IllegalStateException("BeanFactory not initialized or already closed - " +
                                    "call 'refresh' before accessing beans via the ApplicationContext");
                           }
                           return beanFactory;
                      }

æˆ‘ä»¬å¯ä»¥å°è¯•è·å–ä¸€ä¸‹:

                    ApplicationContext context = new ClassPathXmlApplicationContext("application.xml");
                    // æˆ‘ä»¬å¯ä»¥ç›´æ¥è·å–æ­¤å¯¹è±¡
                    System.out.println(context.getAutowireCapableBeanFactory());

æ­£æ˜¯å› ä¸ºè¿™æ · ApplicationContextæ‰å…·æœ‰äº†ç®¡ç†å’Œç”ŸæˆBeanå¯¹è±¡çš„èƒ½åŠ›ğŸ’¡

ä¸è¿‡ æˆ‘ä»¬çš„é…ç½®å¯èƒ½æ˜¯XML å¯èƒ½æ˜¯é…ç½®ç±» é‚£ä¹ˆSpringè¦å¦‚ä½•è¿›è¡Œè§£æ å°†è¿™äº›å˜æˆå¯¹åº”çš„BeanDefinitionå¯¹è±¡å‘¢? ä½¿ç”¨BeanDefinitionReaderå°±å¯ä»¥:

                    public static void main() {

                        DefaultListableBeanFactory factory = new DefaultListableBeanFactory();
                        // æ¯”å¦‚æˆ‘ä»¬è¦è¯»å–XMLé…ç½® æˆ‘ä»¬ç›´æ¥ä½¿ç”¨XmlBeanDefinitionReaderå°±å¯ä»¥å¿«é€Ÿè¿›è¡Œæ‰«æ
                        XmlBeanDefinitionReader reader = new XmlBeanDefinitionReader(factory);
                        // åŠ è½½æ­¤XMLæ–‡ä»¶ä¸­æ‰€æœ‰çš„Beanå®šä¹‰åˆ°Beanå·¥å‚ä¸­
                        reader.loadBeanDefinitions(new ClassPathResource("application.xml"));

                        // å¯ä»¥çœ‹åˆ°èƒ½æ­£å¸¸ç”Ÿäº§æ­¤Beançš„å®ä¾‹å¯¹è±¡
                        System.out.println(factory.getBean(Student.class));

                    }

å› æ­¤ é’ˆå¯¹äºä¸åŒç±»å‹çš„é…ç½®æ–¹å¼ ApplicationContextæœ‰ç€å¤šç§å®ç° å…¶ä¸­å¸¸ç”¨çš„æœ‰:

    > ClassPathXmlApplicationContext: é€‚ç”¨äºç±»è·¯å¾„ä¸‹çš„XMLé…ç½®æ–‡ä»¶
    > FileSystemXmlApplicationContext: é€‚ç”¨äºéç±»è·¯å¾„ä¸‹çš„XMLé…ç½®æ–‡ä»¶
    > AnnotationConfigApplicationContext: é€‚ç”¨äºæ³¨è§£é…ç½®å½¢å¼

æ¯”å¦‚ClassPathXmlApplicationContextåœ¨åˆå§‹åŒ–çš„æ—¶å€™å°±ä¼šåˆ›å»ºä¸€ä¸ªå¯¹åº”çš„XmlBeanDefinitionReaderè¿›è¡Œæ‰«æ:

                    @Override
                    protected void loadBeanDefinitions(DefaultListableBeanFactory beanFactory) throws BeansException, IOException {
                       // ä¸ºç»™å®šçš„BeanFactoryåˆ›å»ºXmlBeanDefinitionReaderä¾¿äºè¯»å–XMLä¸­çš„Beané…ç½®
                       XmlBeanDefinitionReader beanDefinitionReader = new XmlBeanDefinitionReader(beanFactory);

                       // å„ç§é…ç½® å¿½ç•¥æ‰
                       beanDefinitionReader.setEnvironment(this.getEnvironment());
                       ...
                       // é…ç½®å®Œæˆå ç›´æ¥å¼€å§‹åŠ è½½XMLæ–‡ä»¶ä¸­çš„Beanå®šä¹‰
                       loadBeanDefinitions(beanDefinitionReader);
                    }

                    protected void loadBeanDefinitions(XmlBeanDefinitionReader reader) throws BeansException, IOException {
                       Resource[] configResources = getConfigResources();   // å…·ä½“åŠ è½½è¿‡ç¨‹æˆ‘å°±ä¸è¯¦ç»†ä»‹ç»äº†
                       if (configResources != null) {
                          reader.loadBeanDefinitions(configResources);
                       }
                       String[] configLocations = getConfigLocations();
                       if (configLocations != null) {
                          reader.loadBeanDefinitions(configLocations);
                       }
                    }

ç°åœ¨ æˆ‘ä»¬å°±å·²ç»çŸ¥é“ Beanå®é™…ä¸Šæ˜¯ä¸€å¼€å§‹é€šè¿‡BeanDefinitionReaderè¿›è¡Œæ‰«æ ç„¶åå°†æ‰€æœ‰Beanä»¥BeanDefinitionå¯¹è±¡çš„å½¢å¼æ³¨å†Œåˆ°å¯¹åº”çš„BeanFactoryä¸­è¿›è¡Œé›†ä¸­ç®¡ç†
è€Œæˆ‘ä»¬ä½¿ç”¨çš„ApplicationContextå®é™…ä¸Šå†…éƒ¨å°±æœ‰ä¸€ä¸ªBeanFactoryåœ¨è¿›è¡ŒBeanç®¡ç† è¿™æ ·å®¹å™¨æ‰æ‹¥æœ‰äº†æœ€åŸºæœ¬çš„Beanç®¡ç†åŠŸèƒ½

å½“ç„¶ BeanFactoryè¿˜å¯ä»¥å…·æœ‰çˆ¶å­å…³ç³» å…¶ä¸­æœ€å…³é”®çš„ä½œç”¨å°±æ˜¯ç»§æ‰¿çˆ¶å®¹å™¨ä¸­æ‰€æœ‰çš„Beanå®šä¹‰ è¿™æ ·çš„è¯
å¦‚æœæˆ‘ä»¬æƒ³è¦åˆ›å»ºä¸€ä¸ªæ–°çš„BeanFactoryå¹¶ä¸”é»˜è®¤å…·æœ‰å…¶ä»–BeanFactoryä¸­æ‰€æœ‰çš„å®šä¹‰å¤–åŠ ä¸€äº›å…¶ä»–çš„ é‚£ä¹ˆå°±å¯ä»¥é‡‡ç”¨è¿™ç§å½¢å¼ è¿™æ˜¯å¾ˆæ–¹ä¾¿çš„ğŸ‘:

                    public static void main(String[] args) {

                        DefaultListableBeanFactory factoryParent = new DefaultListableBeanFactory();
                        DefaultListableBeanFactory factoryChild = new DefaultListableBeanFactory();
                        // åœ¨çˆ¶å·¥å‚ä¸­æ³¨å†ŒA
                        factoryParent.registerBeanDefinition("a", new RootBeanDefinition(A.class));
                        // åœ¨å­å·¥å‚ä¸­æ³¨å†ŒB, C
                        factoryChild.registerBeanDefinition("b", new RootBeanDefinition(B.class));
                        factoryChild.registerBeanDefinition("c", new RootBeanDefinition(C.class));
                        // æœ€åè®¾å®šå­å·¥å‚çš„çˆ¶å·¥å‚
                        factoryChild.setParentBeanFactory(factoryParent);

                    }

                    static class A { }
                    static class B { }
                    static class C { }

ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹æ˜¯ä¸æ˜¯æˆ‘ä»¬æƒ³çš„é‚£æ ·:

                    System.out.println(factoryChild.getBean(A.class)); // å­å·¥å‚ä¸ä»…èƒ½è·å–åˆ°è‡ªå·±çš„ä¹Ÿå¯ä»¥æ‹¿åˆ°çˆ¶å·¥å‚çš„
                    System.out.println(factoryChild.getBean(B.class));
                    System.out.println(factoryChild.getBean(C.class));

                    System.out.println(factoryParent.getBean(B.class)); // æ³¨æ„çˆ¶å·¥å‚ä¸èƒ½æ‹¿åˆ°å­å·¥å‚çš„ å°±åƒç±»çš„ç»§æ‰¿ä¸€æ ·

åŒæ ·çš„ æˆ‘ä»¬åœ¨ä½¿ç”¨ApplicationContextæ—¶ ä¹Ÿå¯ä»¥è®¾å®šè¿™æ ·çš„çˆ¶å­å…³ç³» æ•ˆæœç›¸åŒ:

                    ApplicationContext contextParent = new ApplicationContext("parent.xml")
                    ApplicationContext contextChild = new ApplicationContext(new String[]{"child.xml"}, contextParent); // ç¬¬ä¸€ä¸ªå‚æ•°åªèƒ½ç”¨æ•°ç»„

å½“ç„¶ é™¤äº†è¿™äº›åŠŸèƒ½ä¹‹å¤– BeanFactoryè¿˜æä¾›äº†å¾ˆå¤šå…¶ä»–çš„ç®¡ç†Beanå®šä¹‰çš„æ–¹æ³• æ¯”å¦‚ç§»é™¤Beanå®šä¹‰ æ‹·è´Beanå®šä¹‰
æ¶ˆè€—å•ä¾‹Beanå®ä¾‹å¯¹è±¡ç­‰åŠŸèƒ½ è¿™é‡Œå°±ä¸ä¸€ä¸€åˆ—å‡ºäº† å„ä½å°ä¼™ä¼´è‡ªå·±è°ƒç”¨ä¸€ä¸‹æµ‹è¯•å°±å¯ä»¥äº† å¾ˆç®€å•

------------------------------------------------------------------------------------------------------------------------------------------------------------

å•ä¾‹Beançš„åˆ›å»ºä¸å¾ªç¯ä¾èµ–
å‰é¢æˆ‘ä»¬è®²è§£äº†é…ç½®çš„Beanæ˜¯å¦‚ä½•è¢«è¯»å–å¹¶åŠ è½½åˆ°å®¹å™¨ä¸­çš„ æ¥ç€æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹Beanå®ä¾‹å¯¹è±¡æ˜¯å¦‚ä½•è¢«åˆ›å»ºå¹¶å¾—åˆ°çš„ æˆ‘ä»¬çŸ¥é“ å¦‚æœè¦å¾—åˆ°ä¸€ä¸ªBeançš„å®ä¾‹å¾ˆç®€å• é€šè¿‡getBeanæ–¹æ³•å°±å¯ä»¥ç›´æ¥æ‹¿åˆ°äº†:

                    ApplicationContext context = new ClassPathXmlApplicationContext("application.xml");
                    System.out.println(context.getBean(student.class)); // é€šè¿‡æ­¤æ–¹æ³•å°±èƒ½å¿«é€Ÿå¾—åˆ°

æˆ‘ä»¬å¯ä»¥ç›´æ¥æ‰¾åˆ°BeanFactoryæ¥å£çš„ä¸€ä¸ªæŠ½è±¡å®ç°AbstractBeanFactoryç±» å®ƒå®ç°ç±»getBean()æ–¹æ³•:

                    public Object getBean(String name) throws BeansException {
                        // å¥—å¨ƒå¼€å§‹äº† åšå¥½å‡†å¤‡ğŸ™†â€
                        return this.doGetBean(name, (Class)null, (Object[])null, false);
                    }

é‚£ä¹ˆæˆ‘ä»¬doGetBean()æ¥ç€æ¥çœ‹æ–¹æ³•é‡Œé¢å¹²äº†ä»€ä¹ˆ è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒé•¿ æˆ‘ä»¬åˆ†æ®µè¿›è¡Œè®²è§£:

                    protected <T> T doGetBean(String name, @Nullable Class<T> requiredType, @Nullable Object[] args, boolean typeCheckOnly) throws BeansException {
                        String beanName = this.transformedBeanName(name);   // è™½ç„¶è¿™é‡Œç›´æ¥ä¼ çš„å°±æ˜¯name ä½†æ˜¯ä¸‡ä¸€æ˜¯åˆ«åå‘¢ æ‰€ä»¥è¿˜å¾—è¦è§£æä¸€ä¸‹å˜æˆåŸæœ¬çš„Beanåå­—
                        Object sharedInstance = this.getSingleton(beanName);   // é¦–å…ˆç›´æ¥è·å–å•ä¾‹Beanå¯¹è±¡
                        Object beanInstance;
                        if (sharedInstance != null && args == null) {   // åˆ¤æ–­æ˜¯å¦æˆåŠŸè·å–åˆ°å…±äº«çš„å•ä¾‹å¯¹è±¡
                        ...

å› ä¸ºæ‰€æœ‰çš„Beané»˜è®¤éƒ½æ˜¯å•ä¾‹æ¨¡å¼ å¯¹è±¡åªä¼šå­˜åœ¨ä¸€ä¸ª å› æ­¤å®ƒä¼šå…ˆè°ƒç”¨çˆ¶ç±»çš„getSingleton()æ–¹æ³•æ¥ç›´æ¥è·å–å•ä¾‹å¯¹è±¡

                    protected <T> T doGetBean(String name, @Nullable Class<T> requiredType, @Nullable Object[] args, boolean typeCheckOnly) throws BeansException {
                        ...
                        if (sharedInstance != null && args == null) {
                            if (this.logger.isTraceEnabled()) {
                                // è¿™é‡Œä¼šåˆ¤æ–­Beanæ˜¯å¦ä¸ºæ­£åœ¨åˆ›å»ºçŠ¶æ€ ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§çŠ¶æ€å‘¢? æˆ‘ä»¬ä¼šåœ¨åé¢è¿›è¡Œä»‹ç»
                                if (this.isSingletonCurrentlyInCreation(beanName)) {
                                    this.logger.trace("Returning eagerly cached instance of singleton bean '" + beanName + "' that is not fully initialized yet - a consequence of a circular reference");
                                } else {
                                    this.logger.trace("Returning cached instance of singleton bean '" + beanName + "'");
                                }
                            }
                              // è¿™é‡ŒgetObjectForBeanInstanceä¼šè¿›è¡Œæœ€ç»ˆå¤„ç†
                              // å› ä¸ºBeanæœ‰ä¸¤ä¸ªç‰¹æ®Šçš„ç±»å‹ å·¥å‚Benaå’Œç©ºBean æ‰€ä»¥è¯´éœ€è¦å•ç‹¬å¤„ç†
                              // å¦‚æœæ˜¯æ™®é€šBeanç›´æ¥åŸæ ·è¿”å›beanInstanceæ¥æ”¶åˆ°æœ€ç»ˆç»“æœ
                            beanInstance = this.getObjectForBeanInstance(sharedInstance, name, beanName, (RootBeanDefinition)null);
                        } else {
                           ...
                        }
                          // æœ€åè¿˜ä¼šè¿›è¡Œä¸€æ¬¡ç±»å‹åˆ¤æ–­ å¦‚æœéƒ½æ²¡é—®é¢˜ ç›´æ¥è¿”å›beanInstanceä½œä¸ºç»“æœ æˆ‘ä»¬å°±å¾—åˆ°Beançš„å®ä¾‹å¯¹è±¡äº†
                          return this.adaptBeanInstance(name, beanInstance, requiredType);
                    }

å®é™…ä¸Šæ•´ä¸ªå•ä¾‹Beançš„åˆ›å»ºè·¯çº¿è¿˜æ˜¯å¾ˆæ¸…æ™°çš„ å¹¶æ²¡æœ‰ä»€ä¹ˆå¾ˆéš¾ç†è§£çš„åœ°æ–¹ åœ¨æ­£å¸¸æƒ…å†µä¸‹ å…¶å®å°±æ˜¯ç®€å•çš„åˆ›å»ºå¯¹è±¡å®ä¾‹å¹¶è¿”å›å³å¯

å…¶ä¸­æœ€å…³é”®çš„æ˜¯å®ƒå¯¹äºå¾ªç¯ä¾èµ–çš„å¤„ç† æˆ‘ä»¬å‘ç° åœ¨ä¸Šé¢çš„ä»£ç ä¸­ å¾—åˆ°å•ä¾‹å¯¹è±¡å ä¼šæœ‰ä¸€ä¸ªå¾ˆç‰¹æ®Šçš„åˆ¤æ–­isSingletonCurrentlyInCreation
è¿™ä¸ªæ˜¯å¹²å˜›çš„? å¯¹è±¡ä¸åº”è¯¥ç›´æ¥åˆ›å»ºå‡ºæ¥å—? ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§æ­£åœ¨åˆ›å»ºçš„çŠ¶æ€å‘¢? æˆ‘ä»¬æ¥ç ”ç©¶ä¸€ä¸‹

å¼€å§‹ä¹‹å‰å…ˆç»™å¤§å®¶æä¸ªé—®é¢˜ğŸ˜²:

    ç°åœ¨æœ‰ä¸¤ä¸ªBean Aå’ŒBéƒ½æ˜¯ä»¥åŸå‹æ¨¡å¼è¿›è¡Œåˆ›å»º è€ŒAä¸­éœ€æ³¨å…¥B Bä¸­éœ€è¦æ³¨å…¥A è¿™æ—¶å°±ä¼šå‡ºç°Aè¿˜æœªåˆ›å»ºå®Œæˆ å°±éœ€è¦B è€ŒBè¿™æ—¶ä¹Ÿæ²¡åˆ›å»ºå®Œæˆ å› ä¸ºBéœ€è¦A è€ŒAç­‰ç€B Båˆç­‰ç€A
    è¿™æ ·å°±åªèƒ½æ— é™å¾ªç¯ä¸‹å»äº†(å°±åƒæ­»é”é‚£ç§æ„Ÿè§‰) æ‰€ä»¥å°±å‡ºç°äº†å¾ªç¯ä¾èµ–çš„é—®é¢˜(åŒç† ä¸€ä¸ªå¯¹è±¡æ³¨å…¥è‡ªå·± è¿˜æœ‰ä¸‰ä¸ªå¯¹è±¡ä¹‹é—´ è®¾ç½®å¤šä¸ªå¯¹è±¡ä¹‹é—´ä¹Ÿä¼šå‡ºç°è¿™ç§æƒ…å†µ)

ä½†æ˜¯ åœ¨å•ä¾‹æ¨¡å¼ä¸‹ ç”±äºæ¯ä¸ªBeanåªä¼šåˆ›å»ºä¸€ä¸ªå®ä¾‹ åªè¦èƒ½å¤Ÿå¤„ç†å¥½å¯¹è±¡ä¹‹é—´çš„å¼•ç”¨å…³ç³» Springå®Œå…¨æœ‰æœºä¼šè§£å†³å•ä¾‹å¯¹è±¡å¾ªç¯ä¾èµ–çš„é—®é¢˜ é‚£ä¹ˆå•ä¾‹æ¨¡å¼ä¸‹æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜çš„å‘¢?

        https://smms.app/image/aRjr1968Lc3BkKH

æˆ‘ä»¬å›åˆ°ä¸€å¼€å§‹çš„getSingleton()æ–¹æ³•ä¸­ ç ”ç©¶ä¸€ä¸‹å®ƒåˆ°åº•æ˜¯å¦‚ä½•å¤„ç†å¾ªç¯ä¾èµ–çš„ å®ƒæ˜¯å¯ä»¥è‡ªåŠ¨è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜çš„â€¼:

                    @Nullable
                    protected Object getSingleton(String beanName, boolean allowEarlyReference) {
                        Object singletonObject = this.singletonObjects.get(beanName);
                        // å…ˆä»ç¬¬ä¸€å±‚åˆ—è¡¨ä¸­æ‹¿Beanå®ä¾‹ æ‹¿åˆ°ç›´æ¥è¿”å›
                        if (singletonObject == null && this.isSingletonCurrentlyInCreation(beanName)) {
                            // å¦‚æœç¬¬ä¸€å±‚æ‹¿ä¸åˆ° å¹¶ä¸”å·²ç»è®¤å®šä¸ºå¤„äºå¾ªç¯çŠ¶æ€ çœ‹çœ‹ç¬¬äºŒå±‚æœ‰æ²¡æœ‰
                            singletonObject = this.earlySingletonObjects.get(beanName);
                            if (singletonObject == null && allowEarlyReference) {
                                synchronized(this.singletonObjects) {
                                    // åŠ é”å†æ‰§è¡Œä¸€æ¬¡ä¸Šè¿°æµç¨‹
                                    singletonObject = this.singletonObjects.get(beanName);
                                    if (singletonObject == null) {
                                        singletonObject = this.earlySingletonObjects.get(beanName);
                                        if (singletonObject == null) {
                                            // ä»ç„¶æ²¡æœ‰è·å–åˆ°å®ä¾‹ åªèƒ½ä»singletonFactoryä¸­è·å–äº†
                                            ObjectFactory<?> singletonFactory = (ObjectFactory)this.singletonFactories.get(beanName);
                                            if (singletonFactory != null) {
                                                singletonObject = singletonFactory.getObject();
                                                // ä¸¢è¿›earlySingletonObjectsä¸­ ä¸‹æ¬¡å°±å¯ä»¥ç›´æ¥åœ¨ç¬¬äºŒå±‚æ‹¿åˆ°äº†
                                                this.earlySingletonObjects.put(beanName, singletonObject);
                                                this.singletonFactories.remove(beanName);
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        return singletonObject;
                    }

çœ‹èµ·æ¥å¾ˆå¤æ‚ğŸ˜µ å®é™…ä¸Šå®ƒä½¿ç”¨äº†ä¸‰çº§ç¼“å­˜çš„æ–¹å¼æ¥å¤„ç†å¾ªç¯ä¾èµ–çš„é—®é¢˜ åŒ…æ‹¬

    > singletonObject: ç”¨äºä¿å­˜å®ä¾‹åŒ– æ³¨å…¥ åˆå§‹åŒ–å®Œæˆçš„beanå®ä¾‹
    > earlySingletonObjects: ç”¨äºä¿å­˜å®ä¾‹åŒ–å®Œæˆçš„beanå®ä¾‹
    > singletonFactories: åœ¨åˆå§‹åˆ›å»ºBeanå¯¹è±¡æ—¶éƒ½ä¼šç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„å•ä¾‹å·¥å‚ç”¨äºè·å–æ—©æœŸå¯¹è±¡

æˆ‘ä»¬å…ˆæ¥ç”»ä¸€ä¸ªæµç¨‹å›¾ç†æ¸…æ•´ä¸ªè¿‡ç¨‹:

        https://smms.app/image/xFfUuaozLpiVg96

æˆ‘ä»¬åœ¨äº†è§£è¿™ä¸ªæµç¨‹ä¹‹å‰ ä¸€å®šè¦å…ˆæ˜ç¡® å•ä¾‹Beanå¯¹è±¡çš„è·å– ä¼šæœ‰å“ªäº›ç»“æœ é¦–å…ˆå°±æ˜¯å¦‚æœæˆ‘ä»¬è·å–çš„Beanå‹æ ¹å°±æ²¡åœ¨å·¥å‚ä¸­æ³¨å†Œ
é‚£å¾—åˆ°çš„ç»“æœè‚¯å®šæ˜¯null å…¶æ¬¡ å¦‚æœæˆ‘ä»¬è·å–çš„Beamå·²ç»æ³¨å†Œäº† é‚£ä¹ˆè‚¯å®šå°±å¯ä»¥å¾—åˆ°è¿™ä¸ªå•ä¾‹å¯¹è±¡ åªæ˜¯ä¸æ¸…æ¥šåˆ›å»ºåˆ°å“ªä¸€ä¸ªé˜¶æ®µäº†

ç°åœ¨æˆ‘ä»¬æ ¹æ®ä¸Šé¢çš„æµç¨‹å›¾ æ¥æ¨¡æ‹Ÿä¸€ä¸‹Aå’ŒBå¾ªç¯ä¾èµ–çš„æƒ…å†µ:

        https://smms.app/image/ezkOUv8Wjrb2tVF

æœ‰çš„å°ä¼™ä¼´å°±ä¼šæœ‰ç–‘é—®äº† çœ‹èµ·æ¥ä¼¼ä¹ä¸¤çº§ç¼“å­˜ä¹Ÿå¯ä»¥è§£å†³é—®é¢˜å•Š å¹²å˜›æä¸‰å±‚è€Œä¸”è¿˜æä¸ªå¯¹è±¡å·¥å‚?ğŸ˜³
è¿™ä¸æ˜¯å¤šæ­¤ä¸€ä¸¾å—? å®é™…ä¸Šè¿™æ˜¯ä¸ºäº†æ»¡è¶³Beançš„ç”Ÿå‘½å‘¨æœŸè€Œåšçš„ é€šè¿‡å·¥å‚è·å–æ—©æœŸå¯¹è±¡ä»£ç å¦‚ä¸‹:

                    protected Object getEarlyBeanReference(String beanName, RootBeanDefinition mbd, Object bean) {
                        Object exposedObject = bean;
                        // è¿™é‡Œå¾ˆå…³é”® ä¼šå¯¹ä¸€äº›ç‰¹åˆ«çš„BeanPostProcessorè¿›è¡Œå¤„ç† æ¯”å¦‚AOPä»£ç†ç›¸å…³çš„ å¦‚æœè¿™ä¸ªBeanæ˜¯è¢«AOPä»£ç†çš„ æˆ‘ä»¬éœ€è¦å¾—åˆ°çš„æ˜¯ä¸€ä¸ªç»è¿‡AOPä»£ç†çš„å¯¹è±¡ è€Œä¸æ˜¯ç›´æ¥åˆ›å»ºå‡ºæ¥çš„å¯¹è±¡ è¿™ä¸ªè¿‡ç¨‹éœ€è¦BeanPostProcessoræ¥å®Œæˆ
                        if (!mbd.isSynthetic() && hasInstantiationAwareBeanPostProcessors()) {
                            for (SmartInstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().smartInstantiationAware) {
                                exposedObject = bp.getEarlyBeanReference(exposedObject, beanName);
                            }
                        }
                        return exposedObject;
                    }

æˆ‘ä»¬ä¼šåœ¨åé¢çš„éƒ¨åˆ†ä¸­è¯¦ç»†ä»‹ç»BeanPostProcessorä»¥åŠAOPçš„å®ç°åŸç† å±Šæ—¶å„ä½å†å›æ¥çœ‹å°±ä¼šæ˜ç™½äº†

------------------------------------------------------------------------------------------------------------------------------------------------------------

åç½®å¤„ç†å™¨ä¸AOP
æ¥ç€æˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸‹PostProcessor å®ƒå…¶å®æ˜¯Springæä¾›çš„ä¸€ç§åç½®å¤„ç†æœºåˆ¶ å®ƒå¯ä»¥è®©æˆ‘ä»¬èƒ½å¤Ÿæ’æ‰‹Bean, BeanFactory, BeanDefinitionçš„åˆ›å»ºè¿‡ç¨‹
ç›¸å½“äºè¿›è¡Œä¸€ä¸ªæœ€ç»ˆçš„å¤„ç† è€Œæœ€åå¾—åˆ°çš„ç»“æœ(æ¯”å¦‚Beanå®ä¾‹ Beanå®šä¹‰ç­‰)å°±æ˜¯ç»è¿‡åç½®å¤„ç†å™¨è¿”å›çš„ç»“æœ å®ƒæ˜¯æ•´ä¸ªåŠ è½½è¿‡ç¨‹çš„æœ€åä¸€æ­¥ğŸª

è€ŒAOPæœºåˆ¶æ­£æ˜¯é€šè¿‡å®ƒæ¥å®ç°çš„ æˆ‘ä»¬é¦–å…ˆæ¥è®¤è¯†ä¸€ä¸‹ç¬¬ä¸€ä¸ªæ¥å£BeanPostProcessor å®ƒç›¸å½“äºBeanåˆå§‹åŒ–çš„ä¸€ä¸ªåç½®åŠ¨ä½œ æˆ‘ä»¬å¯ä»¥ç›´æ¥å®ç°æ­¤æ¥å£:

                        @Component // æ³¨æ„å®ƒåç½®å¤„ç†å™¨ä¹Ÿè¦è¿›è¡Œæ³¨å†Œ
                        public class TestBeanProcessor implements BeanPostProcessor {

                            @Override
                            public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {

                                System.out.println(beanName); // æ‰“å°beançš„åç§°
                                return bean;

                            }

                            @Override
                            public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
                                return BeanPostProcessor.super.postProcessBeforeInitialization(bean, beanName);
                            }

                        }

æˆ‘ä»¬å‘ç° æ­¤æ¥å£ä¸­åŒ…æ‹¬ä¸¤ä¸ªæ–¹æ³• ä¸€ä¸ªæ˜¯postProcessAfterInitializationç”¨äºåœ¨Beanåˆå§‹åŒ–ä¹‹åè¿›è¡Œå¤„ç† æ³¨æ„è¿™é‡Œçš„åˆå§‹åŒ–ä¸æ˜¯åˆ›å»ºå¯¹è±¡ è€Œæ˜¯è°ƒç”¨ç±»çš„åˆå§‹åŒ–æ–¹æ³• æ¯”å¦‚:

                        @Component
                        public class TestBeanProcessor implements BeanPostProcessor {

                            @Override
                            public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {

                                System.out.println("æˆ‘æ˜¯ä¹‹å: " + beanName);
                                return bean; // è¿™é‡Œè¿”å›çš„Beanç›¸å½“äºæœ€ç»ˆçš„ç»“æœäº† æˆ‘ä»¬ä¾ç„¶èƒ½å¤Ÿæ’æ‰‹ä¿®æ”¹ è¿™é‡Œè¿”å›ä¹‹åæ˜¯ä»€ä¹ˆå°±æ˜¯ä»€ä¹ˆäº†

                            }

                            @Override
                            public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {

                                System.out.println("æˆ‘æ˜¯ä¹‹å‰: " + beanName);
                                return bean; // è¿™é‡Œè¿”å›çš„Beanä¼šäº¤ç»™ä¸‹ä¸€ä¸ªé˜¶æ®µ ä¹Ÿå°±æ˜¯åˆå§‹åŒ–æ–¹æ³•

                            }

                        }

                        @Component
                        public class TestServiceImpl implements TestService {

                            public TestServiceImpl() {
                                System.out.println("æˆ‘æ˜¯æ„é€ æ–¹æ³•");
                            }

                            @PostConstruct
                            public void init() {
                                System.out.println("æˆ‘æ˜¯åˆå§‹åŒ–æ–¹æ³•");
                            }

                            TestMapper mapper;

                            @Autowired
                            public void setMapper(TestMapper mapper) {

                                System.out.println("æˆ‘æ˜¯ä¾èµ–æ³¨å…¥");
                                this.mapper = mapper;

                            }

                            ...
                        }

è€ŒTestServiceImplçš„åŠ è½½é¡ºåºä¸ºâ¬:

                    æˆ‘æ˜¯æ„é€ æ–¹æ³•
                    æˆ‘æ˜¯ä¾èµ–æ³¨å…¥
                    æˆ‘æ˜¯ä¹‹å‰: testServiceImpl
                    æˆ‘æ˜¯åˆå§‹åŒ–æ–¹æ³•
                    æˆ‘æ˜¯ä¹‹å: testServiceImpl

ç°åœ¨æˆ‘ä»¬å†æ¥æ€»ç»“ä¸€ä¸‹ä¸€ä¸ªBeançš„åŠ è½½æµç¨‹:

[Beanå®šä¹‰]é¦–å…ˆæ‰«æBeanåŠ è½½Beanå®šä¹‰ -> [ä¾èµ–æ³¨å…¥]æ ¹æ®Beanå®šä¹‰é€šè¿‡åå°„åˆ›å»ºBeanå®ä¾‹ -> [ä¾èµ–æ³¨å…¥]è¿›è¡Œä¾èµ–æ³¨å…¥(é¡ºä¾¿è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜) ->
[åˆå§‹åŒ–Bean]BeanPostProcessorçš„åˆå§‹åŒ–ä¹‹å‰æ–¹æ³• -> [åˆå§‹åŒ–Bean]Beanåˆå§‹åŒ–æ–¹æ³• -> [åˆå§‹åŒ–Bean]BeanPostProcessorçš„åˆå§‹åŒ–ä¹‹åæ–¹æ³• -> [å®Œæˆ]æœ€ç»ˆå¾—åˆ°çš„BeanåŠ è½½å®Œæˆçš„å®ä¾‹

åˆ©ç”¨è¿™ç§æœºåˆ¶ ç†è§£AOPçš„å®ç°è¿‡ç¨‹å°±éå¸¸ç®€å•äº† AOPå®é™…ä¸Šä¹Ÿæ˜¯é€šè¿‡è¿™ç§æœºåˆ¶å®ç°çš„å®ƒçš„å®ç°ç±»æ˜¯AnnotationAwareAspectJAutoProxyCreator
è€Œå®ƒå°±æ˜¯å†æœ€åå¯¹Beanè¿›è¡Œäº†ä»£ç† å› æ­¤æœ€åæˆ‘ä»¬å¾—åˆ°çš„ç»“æœå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç†çš„å¯¹è±¡(æœ‰å…³è¯¦ç»†å®ç°è¿‡ç¨‹ è¿™é‡Œå°±ä¸è¿›è¡Œä¾‹ä¸¾äº† æ„Ÿå…´è¶£çš„å¯ä»¥ç»§ç»­æ·±å…¥)

é‚£ä¹ˆè‚¯å®šæœ‰äººæœ‰ç–‘é—®äº† è¿™ä¸ªç±»æ²¡æœ‰è¢«æ³¨å†Œå•Š é‚£æŒ‰ç†è¯´å®ƒä¸åº”è¯¥å‚ä¸åˆ°Beançš„åˆå§‹åŒ–æµç¨‹ä¸­çš„ ä¸ºä»€ä¹ˆå®ƒç›´æ¥å°±è¢«åŠ è½½äº†å‘¢?ğŸ•š

è¿˜è®°å¾—@EnableAspectJAutoProxyå—? æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å®šä¹‰çš„å°±çŸ¥é“äº†:

                    @Target({ElementType.TYPE})
                    @Retention(RetentionPolicy.RUNTIME)
                    @Documented
                    @Import({AspectJAutoProxyRegistrar.class})
                    public @interface EnableAspectJAutoProxy {
                        boolean proxyTargetClass() default false;

                        boolean exposeProxy() default false;
                    }

æˆ‘ä»¬å‘ç°å®ƒä½¿ç”¨äº†@Importæ¥æ³¨å†ŒAspectJAutoProxyRegistrar é‚£ä¹ˆè¿™ä¸ªç±»åˆæ˜¯ä»€ä¹ˆå‘¢ æˆ‘ä»¬æ¥ç€æ¥çœ‹:

                    class AspectJAutoProxyRegistrar implements ImportBeanDefinitionRegistrar {
                        AspectJAutoProxyRegistrar() {
                        }

                        public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {
                            // æ³¨å†ŒAnnotationAwareAspectJAutoProxyCreatoråˆ°å®¹å™¨ä¸­
                            AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry);
                            AnnotationAttributes enableAspectJAutoProxy = AnnotationConfigUtils.attributesFor(importingClassMetadata, EnableAspectJAutoProxy.class);
                            if (enableAspectJAutoProxy != null) {
                                if (enableAspectJAutoProxy.getBoolean("proxyTargetClass")) {
                                    AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry);
                                }

                                if (enableAspectJAutoProxy.getBoolean("exposeProxy")) {
                                    AopConfigUtils.forceAutoProxyCreatorToExposeProxy(registry);
                                }
                            }

                        }
                    }

å®ƒå®ç°äº†æ¥å£ è¿™ä¸ªæ¥å£ä¹Ÿæ˜¯Springæä¾›çš„ä¸€ç§BeanåŠ è½½æœºåˆ¶ å®ƒæ”¯æŒç›´æ¥å‘å®¹å™¨ä¸­æ·»åŠ Beanå®šä¹‰ å®¹å™¨ä¹Ÿä¼šåŠ è½½è¿™ä¸ªBean:

    > ImportBeanDefinitionRegistrarç±»åªèƒ½é€šè¿‡å…¶ä»–ç±»@Importçš„æ–¹å¼æ¥åŠ è½½ é€šå¸¸æ˜¯å¯åŠ¨ç±»æˆ–é…ç½®ç±»
    > ä½¿ç”¨@Import å¦‚æœæ‹¬å·ä¸­çš„ç±»æ˜¯ImportBeanDefinitionRegistrarçš„å®ç°ç±» åˆ™ä¼šè°ƒç”¨æ¥å£ä¸­æ–¹æ³•(ä¸€èˆ¬ç”¨äºæ³¨å†ŒBean)
    > å®ç°è¯¥æ¥å£çš„ç±»æ‹¥æœ‰æ³¨å†Œbeançš„èƒ½åŠ›

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ­¤æ¥å£æä¾›äº†ä¸€ä¸ªBeanDefinitionRegistryæ­£æ˜¯ç”¨äºæ³¨å†ŒBeançš„å®šä¹‰çš„

å› æ­¤ å½“æˆ‘ä»¬æ‰“ä¸Šäº†@EnableAspectJAutoProxyæ³¨è§£ä¹‹å é¦–å…ˆä¼šé€šè¿‡@ImportåŠ è½½AspectJAutoProxyRegistrar ç„¶åè°ƒç”¨å…¶registerBeanDefinitionsæ–¹æ³•
ç„¶åä½¿ç”¨å·¥å…·ç±»æ³¨å†ŒAnnotationAwareAspectJAutoProxyCreatoråˆ°å®¹å™¨ä¸­ è¿™æ ·åœ¨æ¯ä¸ªBeanåˆ›å»ºä¹‹å å¦‚æœéœ€è¦ä½¿ç”¨AOP é‚£ä¹ˆå°±ä¼šé€šè¿‡AOPçš„åç½®å¤„ç†å™¨è¿›è¡Œå¤„ç† æœ€åè¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡

æˆ‘ä»¬ä¹Ÿå¯ä»¥å°è¯•ç¼–å†™ä¸€ä¸ªè‡ªå·±çš„ImportBeanDefinitionRegistrarå®ç° å®ç°ç¼–å†™ä¸€ä¸ªæµ‹è¯•Bean:

                    public class TestBean {

                        @PostConstruct
                        void init() {
                            System.out.println("æˆ‘è¢«åˆå§‹åŒ–äº†");
                        }

                    }

                    public class TestBeanDefinitionRegistrar implements ImportBeanDefinitionRegistrar  {

                        @Override
                        public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {

                            BeanDefinition definition = BeanDefinitionBuilder.rootBeanDefinition(Student.class).getBeanDefinition();
                            registry.registerBeanDefinition("lbwnb", definition);

                        }

                    }

è§‚å¯Ÿæ§åˆ¶å°è¾“å‡º æˆåŠŸåŠ è½½Beanå®ä¾‹

ä¸BeanPostProcessorå·®ä¸å¤šçš„è¿˜æœ‰BeanFactoryPostProcessor å®ƒå’Œå‰è€…ä¸€æ · ä¹Ÿæ˜¯ç”¨äºæˆ‘ä»¬è‡ªå·±å¤„ç†åç½®åŠ¨ä½œçš„ ä¸è¿‡è¿™é‡Œæ˜¯ç”¨äºå¤„ç†BeanFactoryåŠ è½½çš„åç½®åŠ¨ä½œ
BeanDefinitionRegistryPostProcessorç›´æ¥ç»§æ‰¿è‡ªBeanFactoryPostProcessor ğŸ™Œå¹¶ä¸”è¿˜æ·»åŠ äº†æ–°çš„åŠ¨ä½œpostProcessBeanDefinitionRegistry
ä½ å¯ä»¥åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ Beanå®šä¹‰æˆ–æ˜¯ä¿®æ”¹å·²ç»å­˜åœ¨çš„Beanå®šä¹‰ è¿™é‡Œæˆ‘ä»¬å°±ç›´æ¥æ¼”ç¤ºBeanDefinitionRegistryPostProcessorçš„å®ç°:

                    @Component
                    public class TestDefinitionProcessor implements BeanDefinitionRegistryPostProcessor {

                        @Override
                        public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) throws BeansException {

                            System.out.println("æˆ‘æ˜¯Beanå®šä¹‰ååç½®å¤„ç†");
                            BeanDefinition definition = BeanDefinitionBuilder.rootBeanDefinition(Student.class).getBeanDefinition();
                            registry.registerBeanDefinition("lbwnb", definition);

                        }

                        @Override
                        public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException {
                            System.out.println("æˆ‘æ˜¯Beanå·¥å‚åç½®å¤„ç†");
                        }

                    }

åœ¨è¿™é‡Œæ³¨å†ŒBeanå®šä¹‰å…¶å®å’Œä¹‹å‰é‚£ç§æ–¹æ³•æ•ˆæœä¸€æ ·
integrationMybatis
æœ€å æˆ‘ä»¬å†å®Œå–„ä¸€ä¸‹BeanåŠ è½½æµç¨‹(å›¾æ ‡éƒ¨åˆ†æ˜¯æ–°å¢çš„):

[Beanå®šä¹‰]é¦–å…ˆæ‰«æBeanåŠ è½½Beanå®šä¹‰ -> âœ…[Beanå®šä¹‰]Beanå®šä¹‰å’ŒBeanå·¥å‚åç½®å¤„ç† -> [ä¾èµ–æ³¨å…¥]æ ¹æ®Beanå®šä¹‰é€šè¿‡åå°„åˆ›å»ºBeanå®ä¾‹ -> [ä¾èµ–æ³¨å…¥]è¿›è¡Œä¾èµ–æ³¨å…¥(é¡ºä¾¿è§£å†³å¾ªç¯ä¾èµ–)
-> [åˆå§‹åŒ–Bean]BeanPostProcessorçš„åˆå§‹åŒ–ä¹‹å‰æ–¹æ³• -> [åˆå§‹åŒ–Bean]Beanåˆå§‹åŒ–æ–¹æ³• -> [åˆå§‹åŒ–Bean]BeanPostProcessorçš„åˆå§‹åŒ–ä¹‹åæ–¹æ³• -> [å®Œæˆ]æœ€ç»ˆå¾—åˆ°BeanåŠ è½½å®Œæˆçš„å®ä¾‹